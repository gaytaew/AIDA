# Анализ модуля Shoot Editor (MVP)

**Расположение:** `/Users/roman/Desktop/Проекты/MIX/fashion-shoot-mvp/src/frontend/shoot-editor.html`
**JS файл:** `/Users/roman/Desktop/Проекты/MIX/fashion-shoot-mvp/src/frontend/shoot-editor.js`

Этот модуль представляет собой расширенный редактор съемок с возможностями генерации на базе промптов (Prompt-to-Shoot), редактирования изображений (Image Editing), и управления версиями.

## 1. Общая структура (HTML)

Интерфейс построен как классическое Single Page Application внутри HTML файла.

### 1.1. Основные блоки:
*   **Editor Header**: Заголовок и главные действия (Сгенерировать из промпта, Новая съемка, Назад).
*   **Prompt Generator (`#prompt-generator`)**: Специальная секция для создания полной съемки из текстового описания (например, "Авангардная съёмка в стиле Vogue...").
*   **Shoots Lists**: Два списка съемок:
    *   Экспериментальные съёмки (raw JSON).
    *   Обычные съёмки (пресеты + пользовательские).
*   **Editor Form (`.editor-form`)**: Основная форма редактирования, которая появляется при выборе существующей съемки или создании новой.

### 1.2. Форма редактирования (`#shoot-form`):
Состоит из нескольких секций (`.form-section`):

1.  **Основная информация**: ID, Название, Описание.
2.  **Вселенная (Universe)**:
    *   Подробные поля: Техника, Эпоха/Стиль, Цветовая палитра, Линза/Камера, Настроение.
    *   *Примечание в UI*: Внешность модели задается отдельно в аватарах.
3.  **Анти-ИИшность (Anti-AI)**:
    *   Большой блок настроек для придания "натуральности" и борьбы с "глянцем" AI.
    *   Опции: Профиль позирования (auto/natural/posed/off), Интенсивность (off/low/medium/high), Главный свет.
    *   Чекбоксы: Ошибки экспозиции, Смешанный ББ, Микродефекты, "Живая" композиция, Расфокус, Флэр/грязное стекло, Motion blur, Пленочное зерно.
    *   Запрещенные слова (Negative Prompts).
4.  **История версий и Редактирование**:
    *   Список версий с датами и превью сцен.
    *   Возможность **отката** к любой версии.
    *   **Image Edit (Изменение изображения)**:
        *   Выбор превью из истории как базы.
        *   Ввод промпта для редактирования (инструкция для AI).
        *   Отображение результата "Было -> Стало".
5.  **Редактирование через промпт (Массовое)**:
    *   Текстовое поле для описания глобальных изменений (например, "сделай свет мягче").
    *   Загрузка референсных изображений.
    *   Авто-отчет изменений ("Что изменилось"), генерируемый системой.
6.  **Сцены (Scenes)**:
    *   Динамический список сцен.
    *   Инструменты добавления сцен:
        *   Генерация сцены (подсказка + промпт + референс).
        *   Ручное добавление (кнопка "+ Добавить сцену").
7.  **Actions**: Сохранить, Проверить, Экспорт JSON, Удалить.

## 2. Логика работы (JavaScript)

Логика сосредоточена в `shoot-editor.js` и использует модульный подход с глобальным состоянием.

### 2.1. Состояние (`state`)
```javascript
let currentShoot = null;      // Текущий объект съемки
let scenes = [];              // Массив сцен текущей съемки
let imageEditBaseState = null; // Выбранное изображение для редактирования
let editReferenceImagesData = []; // Загруженные референсы
```

### 2.2. API Взаимодействие
Скрипт активно общается с бэкендом (вероятно, Express/Node.js):
*   `/api/shoots`, `/api/experimental-shoots` - Получение списков.
*   `/api/shoots/:id` - Получение полной съемки.
*   `/api/shoots/:id/versions` - Получение истории версий.
*   `/api/shoots/:id/restore/:version` - Откат версии.
*   `/api/shoots/:id/edit` - Умное редактирование съемки через LLM (отправляет промпт и референсы, получает JSON diff).

### 2.3. Ключевые функции
*   **`loadShoots()`**: Загружает оба списка съемок параллельно.
*   **`loadVersions(shootId)`**: Загружает историю и рендерит превью. Поддерживает открытие превью в новой вкладке и выбор превью для редактирования.
*   **`applyEdit()`**: Сложная функция "умного редактирования".
    1.  Делает снапшот текущей съемки.
    2.  Отправляет промпт на `/api/shoots/.../edit`.
    3.  Получает обновленный объект съемки.
    4.  Вызывает `computeShootEditChanges` для генерации отчета diff (что именно изменилось в полях JSON).
    5.  Обновляет UI.
*   **`computeShootEditChanges(before, after)`**: Сравнивает два объекта съемки (до и после редактирования) и формирует список изменений для пользователя. Сравнивает поля вселенной и настройки сцен.

### 2.4. Anti-AI Logic
В коде жестко прописаны параметры "Anti-AI" (разделы "Анти-ИИшность"), которые, судя по названиям полей (`anti-ai-exposure-errors`, `anti-ai-micro-defects` и т.д.), предназначены для добавления "шума" и несовершенств в промпты генерации, чтобы сделать результат более фотореалистичным и менее "нейросетевым".

## 3. Вывод
Это мощный инструмент для "режиссуры" съемок. В отличие от `shoot-composer` (который является пошаговым визардом), `shoot-editor` — это **профессиональная панель управления**, позволяющая:
1.  Тонко настраивать параметры стиля ("Вселенная").
2.  Управлять "физикой" и "честностью" изображения через Anti-AI блок.
3.  Использовать AI для редактирования самой структуры съемки (LLM-driven editing).
4.  Работать с историей версий и откатами.
