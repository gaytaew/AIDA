# AIDA Shoot Generator — Спецификация логики

> **Этот файл — источник истины по логике генератора.**  
> При любых изменениях в проекте сначала сверяться с этим документом, затем обновлять его.

---

## 1. Общее описание

**Цель генератора**: Создание фотореалистичных фэшн-съёмок с использованием AI (Gemini/Vertex — Nano Banana Pro).

**Ключевой принцип**: Все изображения генерируются ТОЛЬКО через Nano Banana Pro (Gemini). Никаких DALL-E, Midjourney и т.д.

**Основные сущности**:
- Вселенная (Universe) — визуальная ДНК съёмки
- Модель (Model) — человек с описанием внешности и личности
- Одежда (Clothing) — референсы одежды
- Кадр (Frame) — поза, ракурс, композиция (БЕЗ локации)
- Локация (Location) — место съёмки, окружение
- Съёмка (Shoot) — сессия, объединяющая всё вышеперечисленное
- История генераций — все сгенерированные изображения

---

## 2. Модули и их роли

---

### 2.1. Модуль "Вселенная" (Universe)

#### Что это
Вселенная — это **визуальная ДНК съёмки**. Она определяет общий стиль, атмосферу, цветовую палитру, тип освещения и другие визуальные параметры, которые должны быть **консистентными** во всех кадрах съёмки.

#### Как создаётся
1. Пользователь загружает **референсные изображения** (примеры съёмок в желаемом стиле)
2. AI анализирует референсы и извлекает визуальные параметры
3. Формируется **промпт-блок вселенной** для генерации

#### Что хранит
- `label` — название вселенной
- `previewSrc` — превью изображение
- `promptBlock` — готовый текстовый блок для промпта генерации
- Технические параметры:
  - `medium` — тип носителя (film, digital, etc.)
  - `grain` — зернистость
  - `lighting` — тип освещения
  - `shadows` — характер теней
  - `colorPalette` — цветовая палитра
  - `skinRendering` — как рендерится кожа
  - `era` — эпоха/стилистика
- `recommendedLocations` — рекомендуемые локации на основе референсов

#### Ключевое требование
**Промпт вселенной должен обеспечивать визуальную консистентность.**

Это значит:
- Все кадры в рамках одной вселенной должны выглядеть как **часть одной съёмки**
- Одинаковый свет, цветокоррекция, контраст, настроение
- Позы и локации могут меняться, но **визуальный стиль остаётся неизменным**

#### Генерация локаций при создании вселенной
При анализе референсов вселенной AI также извлекает **рекомендуемые локации**.

**Важно**: Эти локации должны **автоматически сохраняться в модуль Локаций** (а не только храниться внутри вселенной).

Характеристики локаций из вселенной:
- Только текстовое описание (без референсных изображений)
- Привязка к исходной вселенной (опционально)
- Доступны для выбора в любой съёмке

#### Зависимости
- Вселенная НЕ зависит от модели, одежды или кадра
- Вселенная МОЖЕТ генерировать локации → они сохраняются в модуль Локаций
- При генерации кадра вселенная передаётся как один из блоков JSON-промпта

---

### 2.2. Модуль "Локации" (Location)

#### Что это
Локация — это **место съёмки**, окружение, в котором находится модель. Локация определяет фон, поверхности, освещение окружения, возможные реквизиты.

#### Два способа создания локаций

##### Способ 1: При генерации Вселенной (автоматически)
- AI анализирует референсы вселенной
- Извлекает подходящие локации
- Локации **автоматически сохраняются в модуль Локаций**
- Только текстовое описание (без референсов)
- Привязка к вселенной-источнику

##### Способ 2: Через модуль Локаций напрямую
- Пользователь создаёт локацию вручную
- **Опционально**: загрузка референсных изображений
- Если есть референсы → генерируется описание + референсы отправляются как коллаж при генерации
- Если нет референсов → только текстовое описание

#### Что хранит
- `id` — уникальный идентификатор
- `label` — название локации
- `description` — детальное текстовое описание для промпта
- `sketchUrl` — превью/эскиз локации (опционально)
- `environmentType` — тип окружения (indoor, outdoor, studio, urban, nature, abstract)
- `surface` — описание поверхности/фона
- `lighting` — описание освещения локации
- `props` — реквизит, объекты в сцене
- `referenceImages` — массив референсных изображений (опционально)
- `sourceUniverseId` — ID вселенной-источника (если создана автоматически)

#### Использование при генерации
- Если локация имеет `referenceImages` → собираются в коллаж и отправляются как location reference
- Описание локации добавляется в JSON-промпт отдельным блоком
- Локация **отделена от кадра** — кадр задаёт только позу, локация задаёт место

#### Зависимости
- Локация МОЖЕТ быть создана из Вселенной (автоматически)
- Локация МОЖЕТ быть создана независимо (вручную)
- При генерации: локация → блок в JSON-промпте + опционально коллаж референсов

---

### 2.3. Модуль "Модели" (Model)

#### Что это
Модель — это **человек**, который будет на фото. Модуль хранит описание внешности и "личности" модели.

#### Как создаётся
1. Пользователь загружает **фотографии модели** (желательно несколько ракурсов)
2. AI анализирует фото и генерирует **текстовое описание внешности**
3. AI генерирует **аватарные ракурсы** (фронт, профиль, 3/4)
4. Пользователь может указать **личность модели**

#### Что хранит

##### Описание внешности (автогенерация)
Детальное текстовое описание:
- Тип телосложения, примерный рост
- Форма лица, структура (скулы, челюсть, подбородок)
- Глаза (форма, цвет, расстояние)
- Брови (форма, толщина)
- Нос (форма, ширина переносицы)
- Губы (форма, пропорции)
- Тон кожи (оттенок, текстура, особенности)
- Волосы (цвет, текстура, длина, пробор)

##### Что НЕ включается в описание внешности
- ❌ Эмоции и выражения лица (задаются в других модулях)
- ❌ Одежда
- ❌ Поза
- ❌ Окружение/локация

##### Личность модели (задаёт пользователь)
Описание того, **для каких типов съёмок подходит модель**:
- Фэшн-съёмки (высокая мода, editorial)
- Коммерческие съёмки (реклама, каталоги)
- Экстремальные съёмки (спорт, активный образ жизни)
- Театральные/драматические кадры
- Шутливые/юмористические съёмки
- Романтические съёмки
- и т.д.

Личность НЕ влияет на внешность, но помогает при подборе модели для конкретной съёмки.

#### Генерация аватарных ракурсов

##### Цель
Создать **нейтральные референсные фото** модели для использования при генерации.

##### Требования к ракурсам
- Формат **"фотопаспорт"** — максимально нейтральный
- **То же лицо** — идентичность должна быть 100% сохранена
- Без эмоций — нейтральное выражение
- Без фона — чистый/нейтральный фон
- Без визуальных эффектов — никакой стилизации
- **Полное сохранение**:
  - Параметров кожи (текстура, тон, особенности)
  - Причёски (цвет, длина, текстура, пробор)
  - Всех параметров лица (пропорции, черты)

##### Ракурсы для генерации
1. **Фронтальный** (анфас) — прямой взгляд в камеру
2. **Профиль** (левый или правый)
3. **3/4 ракурс** — полуповорот

##### Как используется
При генерации кадра все ракурсы модели собираются в **коллаж** и отправляются как identity reference в Gemini.

#### Зависимости
- Модель НЕ зависит от вселенной, одежды, кадра
- Модель может иметь описание "личности" для подбора
- При генерации: фото модели → коллаж → identity reference в промпте

---

### 2.4. Модуль "Кадры" (Frames / Каталог кадров)

#### Что это
Кадр — это **шаблон позы и композиции**. Кадр определяет ТОЛЬКО постановку: позу модели, ракурс камеры, план, композицию. Кадр НЕ содержит информацию о локации, одежде, лице, причёске.

#### Как создаётся
1. Пользователь загружает **референсное изображение** (пример позы)
2. AI анализирует референс и извлекает параметры постановки
3. AI генерирует **эскиз кадра** — абстрактный силуэт
4. Пользователь **видит эскиз ДО сохранения** кадра
5. При подтверждении — кадр сохраняется с эскизом и описанием

#### Что хранит
- `id` — уникальный идентификатор
- `label` — название кадра
- `description` — описание для промпта (только поза и композиция!)
- `sketchAsset` — сгенерированный эскиз
- Технические параметры:
  - `shotSize` — план (full_body, medium, close_up, extreme_close_up, etc.)
  - `cameraAngle` — угол камеры (eye_level, high_angle, low_angle, bird_eye, worm_eye)
  - `poseType` — тип позы (standing, sitting, lying, walking, jumping, etc.)
  - `composition` — композиция (rule_of_thirds, centered, diagonal, etc.)
  - `focusPoint` — точка фокуса (face, hands, full figure, etc.)
  - `poseDescription` — детальное описание положения тела

#### Требования к описанию кадра
**ВКЛЮЧАЕТСЯ:**
- ✅ План (крупность кадра)
- ✅ Угол камеры, направление съёмки
- ✅ Положение камеры
- ✅ Поза модели (положение тела, рук, ног, головы)
- ✅ Композиция кадра
- ✅ Точка фокуса

**НЕ ВКЛЮЧАЕТСЯ:**
- ❌ Черты лица, детали лица
- ❌ Одежда, обувь
- ❌ Причёска
- ❌ Локация, фон, окружение
- ❌ Конкретные предметы мебели/реквизита
- ❌ Эмоции (задаются отдельно)

#### Генерация эскиза кадра

##### Стиль эскиза
Все эскизы должны быть **в едином стиле**:
- **Абстрактный силуэт** — не детализированный человечек из палочек
- **Объёмная фигура** без деталей — как манекен или контурная скульптура
- **Нейтральный серый/монохромный** стиль
- **Без лица** — голова как гладкая форма, без черт
- **Без одежды** — голый силуэт или базовое обтягивающее "трико"
- **Без причёски** — голова как простая форма
- **Чёткое положение тела** — руки, ноги, корпус, наклон головы видны ясно
- **Минимальный фон** — нейтральный или пустой

##### Процесс генерации
1. Загружается референс позы
2. AI анализирует позу и извлекает параметры
3. AI генерирует эскиз в заданном стиле
4. **Эскиз показывается пользователю ДО сохранения**
5. Пользователь может: принять, перегенерировать, или отменить

#### Использование при генерации съёмки
Когда кадр выбран для генерации:
1. **Описание кадра** добавляется в JSON-промпт (блок `frame`)
2. **Эскиз кадра** отправляется как **референс позы** в Gemini
3. В промпте указывается: "Use the sketch as pose reference"

#### Зависимости
- Кадр НЕ зависит от вселенной, модели, одежды, локации
- Кадр — чистый шаблон позы
- При генерации: эскиз → pose reference, описание → блок промпта

---

### 2.5. Модуль "Одежда" (Clothing)

> *Будет дополнено*

---

### 2.6. Модуль "Съёмка" (Shoot Composer)

> *Будет дополнено*

---

## 3. Параметры генерации (на последнем шаге)

При генерации кадра пользователь настраивает дополнительные параметры:

### 3.1. Формат изображения
- Ориентация: вертикальная (3:4), горизонтальная (4:3), квадрат (1:1)
- Качество/размер: 1K, 2K, 4K

### 3.2. Параметр "Позирование" (Posing Style)

Определяет **степень постановочности** позы.

| Значение | Название | Описание |
|----------|----------|----------|
| 1 | Случайный | Максимально естественный, будто случайный кадр. Спонтанная поза. |
| 2 | Естественный | Натуральная поза, но осознанная. Модель знает о съёмке. |
| 3 | Постановочный | Чёткая постановка, художественный кадр. |
| 4 | Студийный | Максимально постановочный, студийный fashion-кадр. |

**Влияние на промпт**: Добавляется инструкция о характере позирования.

### 3.3. Параметр "Следование референсу позы" (Pose Adherence)

Определяет **насколько точно** следовать эскизу кадра.

| Значение | Название | Описание |
|----------|----------|----------|
| 1 | Приблизительно | Общий характер позы (сидит/стоит/лежит). Детали свободные. |
| 2 | Похоже | Похожая поза, основные линии тела совпадают. |
| 3 | Точно | Поза максимально близка к эскизу. |
| 4 | Точь-в-точь | Контуры фигуры должны совпадать с эскизом. |

**Влияние на промпт**: 
- Низкие значения: "Pose should be generally similar to the reference (sitting/standing/etc.)"
- Высокие значения: "STRICTLY follow the pose reference. Body position, limb angles, head tilt must match exactly."

**UI**: Ползунок от 1 до 4 или выпадающий список.

---

## 4. Пайплайн генерации кадра

> *Будет дополнено после описания остальных модулей*

---

## 5. История генераций

> *Будет дополнено*

---

## 6. Действия над кадром

> *Будет дополнено*

---

## 7. Ограничения и инварианты

### Генерация изображений
- ✅ Все изображения генерируются ТОЛЬКО через Nano Banana Pro (Gemini/Vertex)
- ✅ Никаких DALL-E, Midjourney, Stable Diffusion

### Разделение ответственности модулей
- ✅ **Вселенная** — только визуальный стиль (свет, цвет, атмосфера)
- ✅ **Локация** — только место съёмки (фон, окружение, поверхности)
- ✅ **Кадр** — ТОЛЬКО поза и композиция (БЕЗ локации, одежды, лица, волос)
- ✅ **Модель** — внешность + личность (БЕЗ эмоций, одежды, позы)
- ✅ **Одежда** — только одежда (отдельно от модели)

### Эскизы кадров
- ✅ Единый абстрактный стиль для всех эскизов
- ✅ Без деталей лица, одежды, причёски
- ✅ Эскиз показывается ДО сохранения кадра
- ✅ Эскиз отправляется как pose reference при генерации

### Локации
- ✅ Локации из вселенной автоматически сохраняются в модуль Локаций
- ✅ Локации можно создавать отдельно с референсами или без

### Аватары моделей
- ✅ Нейтральный формат "фотопаспорт"
- ✅ 100% сохранение идентичности
- ✅ Без эмоций, без фона, без стилизации

---

## 8. История изменений

| Версия | Дата | Изменения |
|--------|------|-----------|
| v0.1 | 2026-01-06 | Первичное описание модулей Вселенная и Модель |
| v0.2 | 2026-01-06 | Добавлены: Локации, Кадры (эскизы), Параметры генерации (позирование, следование референсу) |


