name: Deploy AIDA to Server

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script_stop: false
          command_timeout: 20m
          script: |
            export TERM=xterm
            
            # Helper for logging
            log() {
              echo "[$1] $2"
            }
            
            log "INFO" "STARTING DEPLOY..."
            
            if [ ! -d "/root/AIDA" ]; then
               git clone git@github.com:gaytaew/AIDA.git /root/AIDA
            fi
            
            cd /root/AIDA
            
            log "INFO" "Git Update..."
            git fetch --all --tags --prune || echo "Git fetch warning"
            
            TARGET_SHA="${{ github.sha }}"
            log "INFO" "Checkout: $TARGET_SHA"
            
            git checkout -f $TARGET_SHA
            git reset --hard $TARGET_SHA
            
            # Check .env
            if [ -f .env ]; then
              log "INFO" ".env file exists."
            else
              log "WARNING" ".env file MISSING! Service might fail."
            fi
            
            # Ensure directories
            log "INFO" "Creating directories..."
            mkdir -p src/backend/store/vision-cache
            mkdir -p src/backend/store/style-presets
            mkdir -p src/backend/store/product-shoot-images
            mkdir -p src/backend/store/food-shoot-images
            
            # Fix permissions (sudo in case user is not root)
            log "INFO" "Fixing permissions..."
            sudo chmod -R 777 src/backend/store || echo "Chmod warning"
            
            log "INFO" "Updating dependencies..."
            # Try install, if fails - continue
            npm install --omit=dev --no-audit || echo "NPM install failed, continuing..."
            
            log "INFO" "Service Restart Sequence..."
            
            # Don't fail script on stop
            sudo systemctl stop aida || echo "Stop warning"
            sleep 5
            
            # Capture start output
            START_OUT=$(sudo systemctl start aida 2>&1)
            START_CODE=$?
            
            if [ $START_CODE -ne 0 ]; then
               log "ERROR" "Start failed: $START_OUT"
            else
               log "INFO" "Service output: $START_OUT"
            fi
            
            log "INFO" "Verifying..."
            sleep 10
            
            STATUS=$(sudo systemctl is-active aida)
            log "INFO" "Service Status: $STATUS"
            
            if [ "$STATUS" != "active" ]; then
               log "ERROR" "SERVICE IS NOT ACTIVE!"
               echo "--- JOURNAL LOGS ---"
               sudo journalctl -u aida -n 50 --no-pager
               echo "--------------------"
               exit 1
            fi
            
            log "INFO" "Health Check..."
            HEALTH=$(curl -s http://localhost:3003/api/health 2>/dev/null || echo "FAILED")
            log "INFO" "Health: $HEALTH"
            
            if echo "$HEALTH" | grep -q '"ok":true'; then
               echo "$HEALTH" | grep -o '"geminiClientVersion":"[^"]*"'
               log "SUCCESS" "DEPLOY COMPLETE"
               exit 0
            else
               log "WARNING" "Health check failed (service is active)"
               exit 1
            fi
