name: Deploy AIDA to Server

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script_stop: true
          command_timeout: 10m
          script: |
            set -e
            export TERM=xterm
            
            LOGFILE="/root/aida_deploy_last.log"
            echo "Starting deploy at $(date)" > $LOGFILE
            
            # Helper for logging
            log() {
              echo "[$1] $2" | tee -a $LOGFILE
            }
            
            log "INFO" "Ensuring directory exists..."
            if [ ! -d "/root/AIDA" ]; then
              git clone git@github.com:gaytaew/AIDA.git /root/AIDA
            fi
            
            cd /root/AIDA
            
            log "INFO" "Fetching updates..."
            git fetch --all --tags --prune
            
            # Force checkout exactly the commit that triggered this workflow
            # origin/main might lag behind slightly or contain cached refs
            TARGET_SHA="${{ github.sha }}"
            log "INFO" "Checking out commit: $TARGET_SHA"
            
            git checkout -f $TARGET_SHA
            git reset --hard $TARGET_SHA
            git clean -fd
            
            log "INFO" "Updating dependencies..."
            # Use npm install instead of ci to be more resilient to lockfile mismatches
            npm install --production --no-audit
            
            log "INFO" "Restarting Service..."
            # Stop first to ensure clean state
            sudo systemctl stop aida || true
            sleep 2
            sudo systemctl start aida
            
            log "INFO" "Verifying Service Status..."
            sleep 5
            
            if sudo systemctl is-active --quiet aida; then
              log "SUCCESS" "AIDA is running."
            else
              log "ERROR" "AIDA failed to start."
              sudo systemctl status aida --no-pager -l | tee -a $LOGFILE
              exit 1
            fi
            
            log "INFO" "Health Check..."
            # Allow service time to initialize
            sleep 5
            HEALTH=$(curl -s http://localhost:3003/api/health 2>/dev/null || echo "FAILED")
            
            log "INFO" "Health Response: $HEALTH"
            
            if echo "$HEALTH" | grep -q '"ok":true'; then
               log "SUCCESS" "Deploy finished successfully."
               exit 0
            else
               log "WARNING" "Health check endpoint failed, but service is running."
               exit 1
            fi
