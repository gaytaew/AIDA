name: Deploy AIDA to Server

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script_stop: false
          command_timeout: 20m
          script: |
            export TERM=xterm
            
            log() {
              echo "[$1] $2"
            }
            
            log "INFO" "STARTING DEPLOY..."
            
            cd /root/AIDA || exit 1
            
            log "INFO" "Git Update..."
            git fetch --all --tags --prune
            
            TARGET_SHA="${{ github.sha }}"
            log "INFO" "Checkout: $TARGET_SHA"
            
            git checkout -f $TARGET_SHA
            git reset --hard $TARGET_SHA
            
            # DIAGNOSTICS
            log "INFO" "=== DIAGNOSTICS ==="
            log "INFO" "Node version: $(node --version)"
            log "INFO" "NPM version: $(npm --version)"
            
            # Check what's using port 3003
            log "INFO" "Port 3003 status:"
            sudo lsof -i :3003 || echo "Port 3003 is free"
            
            # Show .env PORT
            if [ -f .env ]; then
              log "INFO" ".env exists. PORT setting:"
              grep PORT .env || echo "PORT not set in .env"
            else
              log "WARNING" ".env MISSING!"
            fi
            
            # Ensure directories
            mkdir -p src/backend/store/vision-cache
            mkdir -p src/backend/store/style-presets
            mkdir -p src/backend/store/product-shoot-images
            mkdir -p src/backend/store/food-shoot-images
            chmod -R 777 src/backend/store
            
            # Rebuild native modules (in case of architecture mismatch)
            log "INFO" "Rebuilding dependencies..."
            npm rebuild 2>&1 || echo "Rebuild warning"
            npm install --omit=dev --no-audit 2>&1 || echo "Install warning"
            
            # Stop service and WAIT
            log "INFO" "Stopping service..."
            sudo systemctl stop aida || true
            sleep 3
            
            # Kill anything on port 3003 just in case
            sudo fuser -k 3003/tcp 2>/dev/null || true
            sleep 2
            
            # Reset systemd failure counter
            sudo systemctl reset-failed aida 2>/dev/null || true
            
            log "INFO" "Starting service..."
            sudo systemctl start aida
            
            log "INFO" "Waiting 15 seconds for startup..."
            sleep 15
            
            STATUS=$(sudo systemctl is-active aida)
            log "INFO" "Service Status: $STATUS"
            
            if [ "$STATUS" != "active" ]; then
               log "ERROR" "SERVICE FAILED!"
               echo "=== LAST 100 LOG LINES ==="
               sudo journalctl -u aida -n 100 --no-pager
               echo "=========================="
               exit 1
            fi
            
            log "INFO" "Health Check..."
            HEALTH=$(curl -s http://localhost:3003/api/health 2>/dev/null || echo "FAILED")
            log "INFO" "Health: $HEALTH"
            
            if echo "$HEALTH" | grep -q '"ok":true'; then
               log "SUCCESS" "DEPLOY COMPLETE"
               exit 0
            else
               log "ERROR" "Health check failed"
               exit 1
            fi
