name: Deploy AIDA to Server

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script_stop: true
          command_timeout: 15m
          script: |
            set -e
            export TERM=xterm
            
            LOGFILE="/root/aida_deploy_last.log"
            echo "Starting deploy at $(date)" > $LOGFILE
            
            # Helper for logging
            log() {
              echo "[$1] $2" | tee -a $LOGFILE
            }
            
            log "INFO" "Ensuring directory exists..."
            if [ ! -d "/root/AIDA" ]; then
              git clone git@github.com:gaytaew/AIDA.git /root/AIDA
            fi
            
            cd /root/AIDA
            
            log "INFO" "Fetching updates..."
            git fetch --all --tags --prune
            
            # Checkout specific SHA to ensure consistency
            TARGET_SHA="${{ github.sha }}"
            log "INFO" "Checking out commit: $TARGET_SHA"
            
            git checkout -f $TARGET_SHA
            git reset --hard $TARGET_SHA
            
            # CRITICAL: Do NOT run git clean -fd, it deletes user data in store!
            # Instead, ensure cache dirs exist
            log "INFO" "Ensuring storage directories exist..."
            mkdir -p src/backend/store/vision-cache
            mkdir -p src/backend/store/style-presets
            mkdir -p src/backend/store/product-shoot-images
            mkdir -p src/backend/store/food-shoot-images
            
            log "INFO" "Updating dependencies..."
            npm install --omit=dev --no-audit
            
            log "INFO" "Restarting Service..."
            # Stop first to ensure clean state
            sudo systemctl stop aida || true
            sleep 2
            sudo systemctl start aida
            
            log "INFO" "Verifying Service Status..."
            sleep 10
            
            if sudo systemctl is-active --quiet aida; then
              log "SUCCESS" "AIDA is running."
            else
              log "ERROR" "AIDA failed to start."
              sudo systemctl status aida --no-pager -l | tee -a $LOGFILE
              
              # Show logs to understand why it failed
              echo "=== SYSTEM LOGTAIL ==="
              journalctl -u aida -n 50 --no-pager
              
              exit 1
            fi
            
            log "INFO" "Health Check..."
            sleep 5
            HEALTH=$(curl -s http://localhost:3003/api/health 2>/dev/null || echo "FAILED")
            
            log "INFO" "Health Response: $HEALTH"
            
            if echo "$HEALTH" | grep -q '"ok":true'; then
               log "SUCCESS" "Deploy finished successfully."
               # Show version for verification
               echo "$HEALTH" | grep -o '"geminiClientVersion":"[^"]*"' || echo "(version not found)"
               exit 0
            else
               log "WARNING" "Health check endpoint failed, but service is running."
               echo "Response: $HEALTH"
               # Don't fail the build if service is running but health check is slow
               exit 0
            fi
