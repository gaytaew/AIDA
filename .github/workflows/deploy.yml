name: Deploy AIDA to Server

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script_stop: true
          command_timeout: 15m
          script: |
            set -e
            export TERM=xterm
            
            # Helper for logging
            log() {
              echo "[$1] $2"
            }
            
            cd /root/AIDA || git clone git@github.com:gaytaew/AIDA.git /root/AIDA
            cd /root/AIDA
            
            log "INFO" "Fetching updates..."
            git fetch --all --tags --prune
            
            TARGET_SHA="${{ github.sha }}"
            log "INFO" "Checkout: $TARGET_SHA"
            
            git checkout -f $TARGET_SHA
            git reset --hard $TARGET_SHA
            
            # Ensure directories exist
            log "INFO" "Fixing storage directories..."
            mkdir -p src/backend/store/vision-cache
            mkdir -p src/backend/store/style-presets
            mkdir -p src/backend/store/product-shoot-images
            mkdir -p src/backend/store/food-shoot-images
            
            # FIX PERMISSIONS: Ensure service can write to store regardless of user
            chmod -R 777 src/backend/store
            
            # Skip npm install to save memory/time if package.json didn't change heavily
            # npm install --omit=dev --no-audit
            
            log "INFO" "Restarting Service..."
            sudo systemctl stop aida || true
            sleep 3
            sudo systemctl start aida
            
            log "INFO" "Waiting for service startup..."
            sleep 10
            
            log "INFO" "Checking status..."
            if sudo systemctl is-active --quiet aida; then
              log "SUCCESS" "AIDA is running."
            else
              log "ERROR" "AIDA failed to start. Last 50 log lines:"
              echo "---------------------------------------------------"
              sudo journalctl -u aida -n 50 --no-pager
              echo "---------------------------------------------------"
              exit 1
            fi
            
            log "INFO" "Health Check..."
            sleep 5
            HEALTH=$(curl -s http://localhost:3003/api/health 2>/dev/null || echo "FAILED")
            
            log "INFO" "Health Response: $HEALTH"
            
            if echo "$HEALTH" | grep -q '"ok":true'; then
               log "SUCCESS" "Deploy finished successfully."
               echo "$HEALTH" | grep -o '"geminiClientVersion":"[^"]*"' || echo "(version not found)"
               exit 0
            else
               log "WARNING" "Health check failed."
               exit 1
            fi
